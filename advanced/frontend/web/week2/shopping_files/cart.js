var __extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)};define(["require","exports","jquery","./search_collection","./event","../options/option_url","../../common/options/option_base","../../common/options/option_event_name","./cart_base"],function(e,t,n,i,r,a,d,u,s){"use strict";var o=150,_=function(){function e(){}return e.format=function(t,n){return n||(n=new e,n.parent_seq=t.parentSeq||null,n.qty=t.qty,n.kind=t.innerKind,n.type=t.type,n.sku_id=t.skuId,n.campaign_seq=t.campSeq||""),t.innerKind==d.ITEM_KIND.KIND_FIXED_COMBO?null==t.detailParentId?n.parent_seq=t.combineId||null:null==n.sku_id?n.sku_id=t.skuId:n.sku_id+=","+t.skuId:t.kind==d.ITEM_KIND.KIND_SALE_BASE?n.parent_seq=null:t.innerKind==d.ITEM_KIND.KIND_MULTIPLE&&(n.parent_seq=t.combineId||null),n},e.formatMall=function(t,n){if(t.campSeq){var i=t.campSeq.indexOf("+");i>0&&(t.campSeq=t.campSeq.substr(0,i))}switch(n||(n=new e,n.parent_seq=null,n.qty=t.qty,n.kind=t.innerKind,n.price_snapshot=t.price,n.campaign_seq=t.campSeq||"",n.type=t.type,n.sku_id=null),t.innerKind){case d.ITEM_KIND.KIND_MAIN:case d.ITEM_KIND.KIND_MULTIPLE:n.parent_seq=t.parentSeq||null,n.sku_id=t.skuId;break;case d.ITEM_KIND.KIND_FIXED_COMBO:case d.ITEM_KIND.KIND_THIRD_PART_MAIN:null==t.parentSeq?(n.parent_seq=t.combineId||null,n.sku_id=t.skuId):null==n.sku_id?n.sku_id=t.skuId:n.sku_id+=","+t.skuId}return n},e.unionUndoList=function(t){var r={},a=t.detailParentId?t.detailParentId:t.detailId,u=i.items||{};if(!t.isVoucherPresent&&!t.isPrize&&t.isSelling)if(t.type==d.GOODS_SOURCE.FEINIU){if(d.ITEM_KIND.KIND_MAIN==t.kind)n.each(u,function(t,i){if(i.detailId==a||i.detailParentId==a){var u=d.ITEM_KIND.KIND_FIXED_COMBO===i.kind?i.detailParentId:i.detailId;if(-1!=n.inArray(i.kind,[d.ITEM_KIND.KIND_MAIN,d.ITEM_KIND.KIND_ACCESSORY,d.ITEM_KIND.KIND_ADD,d.ITEM_KIND.KIND_GIFT,d.ITEM_KIND.KIND_COMBO,d.ITEM_KIND.KIND_FIXED_COMBO])){var s=e.format(i,r[u]);!r[u]&&(r[u]=s)}}});else if(d.ITEM_KIND.KIND_SALE_BASE==t.kind){var s=e.format(t,r[t.detailId]);!r[t.detailId]&&(r[t.detailId]=s)}}else d.ITEM_KIND.KIND_MULTIPLE!=t.innerKind&&d.ITEM_KIND.KIND_THIRD_PART_MAIN!=t.kind&&n.each(u,function(t,n){if(n.detailId==a||n.detailParentId==a){var i=n.detailParentId?n.detailParentId:n.detailId,d=e.formatMall(n,r[i]);!r[i]&&(r[i]=d)}});var o=[];return n.each(r,function(e,t){o.push(t)}),o},e}(),l=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.handel=function(e,t){var i={return_cart_data:!0,product_list:[]},r=[];return n.each(e,function(e,t){var n=new I(t);r.push(n)}),i.product_list.push(r),this.send(a.COMMON_URL.ADD_LIST,n.extend(this.getDefaultCartData(),i),t)},t}(s),I=function(){function e(e){this.sm_seq=null,this.type=0,this.qty=0,this.parent_seq=null,this.kind=1,this.campaign_seq="",e&&n.extend(this,e)}return e}(),c=function(e){function t(){var t=e.call(this)||this;return t.queue=[],t.undoList=[],r.on(u.COMMON_EVENT_NAME.UNDO_DEL_ITEM,function(){if(t.timer&&clearTimeout(t.timer),t.deffered=null,t.queue.length)r.broadcast(u.COMMON_EVENT_NAME.UNDO_DEL_COMPLETE,[t.queue.slice(0)]),t.queue.length=0;else{var e={undo_product_list:t.undoList};t.send(a.COMMON_URL.UNDO_DEL,n.extend(t.getDefaultCartData(),e),{undo:!0}).then(function(e){t.undoList=[],t.undoDelAmount(t.undoList),r.broadcast(u.COMMON_EVENT_NAME.UNDO_DEL_COMPLETE,e)})}}),t}return __extends(t,e),t.prototype.add=function(e,t){var i=this;n.isArray(e)?n.each(e,function(e,n){i.queue.push({id:n,flag:t})}):this.queue.push({id:e,flag:t})},t.prototype.submit=function(){var e=this;return this.deffered=n.Deferred(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){var t={is_html:!0,is_get_all:!0,cart_detail_ids:[],cart_detail_qty:[]};n.each(e.queue,function(r,a){var u,s,o=i.item(a.id),l=[];o&&-1==n.inArray(o.kind,[d.ITEM_KIND.KIND_CAMP_AMOUNT_GIFT,d.ITEM_KIND.KIND_CAMP_NUMBER_GIFT])&&(u=o.trackId,s=o.qty,o.kind===d.ITEM_KIND.KIND_SALE_BASE&&(u=o.detailParentId),o.kind===d.ITEM_KIND.KIND_THIRD_PART_MAIN&&(u=o.detailId),-1!=n.inArray(o.kind,[d.ITEM_KIND.KIND_CAMP_AMOUNT_BUY,d.ITEM_KIND.KIND_CAMP_NUMBER_BUY])&&(u=o.detailId,a.flag=!0),!a.flag&&(l=_.unionUndoList(o)),l&&l.length&&e.undoList.push(l)),null!=u&&(t.cart_detail_ids.push(u),t.cart_detail_qty.push({cart_detail_id:u,qty:s}))}),e.send(a.COMMON_URL.DELETE_LIST,n.extend(e.getDefaultCartData(),t)).then(function(t){e.deffered&&e.deffered.resolve(t),e.deffered=null,e.queue.length=0,e.undoDelAmount(e.undoList)},function(t){e.deffered&&e.deffered.reject(t),e.deffered=null,e.queue.length=0})},o),this.deffered.promise()},t.prototype.handel=function(e,t){return this.add(e,t),this.submit()},t.prototype.clear=function(){var e=this,t={};return this.deffered=n.Deferred(),this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){n.each(i.items,function(t,i){var r=[];!i||i.type==d.GOODS_SOURCE.MALL&&null!=i.parentSeq||-1!=n.inArray(i.kind,d.ITEM_KIND.KIND_GROUP_CAMP)||(r=_.unionUndoList(i),r.length&&e.undoList.push(r))}),e.send(a.COMMON_URL.CLEAR_ALL,n.extend(e.getDefaultCartData(),t)).then(function(t){e.deffered&&e.deffered.resolve(t),e.deffered=null,e.undoDelAmount(e.undoList)},function(t){e.deffered&&e.deffered.reject(t),e.deffered=null})},o),this.deffered.promise()},t.prototype.undoDelAmount=function(e){var i=0;e&&n.each(e,function(e,t){n.each(t,function(e,t){t.kind!=d.ITEM_KIND.KIND_MAIN&&t.kind!=d.ITEM_KIND.KIND_FIXED_COMBO&&t.kind!=d.ITEM_KIND.KIND_MULTIPLE||t.type!=d.GOODS_SOURCE.FEINIU?t.type==d.GOODS_SOURCE.MALL&&i++:i++})}),t.undoDelMsg(i)},t.undoDelMsg=function(e){e?r.broadcast(u.COMMON_EVENT_NAME.SHOW_DEL_MSG,{count:e}):r.broadcast(u.COMMON_EVENT_NAME.DEL_COMPLETE)},t}(s),f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.addManager=new l,t.delManager=new c,t}return __extends(t,e),t.prototype.add=function(e,t){return this.addManager.handel(e,t)},t.prototype.del=function(e,t){return this.delManager.handel(e,t)},t.prototype.clear=function(){return this.delManager.clear()},t.prototype.selectAll=function(e){var t=this;return this.selectDefer=n.Deferred(),this.selectHandel&&clearTimeout(this.selectHandel),this.selectHandel=setTimeout(function(){var i={is_selected:!!e};t.send(a.COMMON_URL.SELECT_ALL,n.extend(t.getDefaultCartData(),i)).then(function(e){t.selectDefer&&t.selectDefer.resolve(e),t.selectDefer=null},function(e){t.selectDefer&&t.selectDefer.reject(e),t.selectDefer=null})},200),this.selectDefer.promise()},t.prototype.load=function(){var e={};return this.send(a.COMMON_URL.GET_ALL,n.extend(this.getDefaultCartData(),e))},t.prototype.loadDefault=function(e){var t=n.Deferred();return this.parseDataDefault(t,e),t.promise()},t.prototype.addSelectedFavorite=function(e){var t=[];n.each(e,function(e,n){var i={skuId:n.skuId,parentSkuId:n.parentSeq,price:n.price||0,type:n.type||d.GOODS_SOURCE.FEINIU,favoriteKind:n.innerKind==d.ITEM_KIND.KIND_MULTIPLE?1:0};t.push(i)});var i={};return i.params=t,n.ajax({method:"POST",dataType:"json",data:{data:JSON.stringify(i)},url:a.COMMON_URL.ADD_SELECTED_FAVORITE})},t.prototype.addFavorite=function(e){var t=this,i=e.detailId,r={favorite_seq:e.skuId,price:e.price||0,type:e.type||d.GOODS_SOURCE.FEINIU,seq_kind:e.kind==d.ITEM_KIND.KIND_MULTIPLE?1:0,is_crossBorder:e.isOverseas,timestamp:(new Date).getTime(),seqKind:null};e.innerKind==d.ITEM_KIND.KIND_MULTIPLE&&(r.seqKind=1);var u=n.Deferred();return n.ajax({method:"GET",dataType:"json",data:r,url:a.COMMON_URL.ADD_FAVORITE}).then(function(e){switch(e=n.extend({status:2,msg:"收藏失败"},e),parseInt(e.status)){case 1:e.id=parseInt(i,10);break;default:e.msg=e.msg||"收藏失败"}return e}).then(function(e){return n.Deferred(function(n){return void 0===e.id||isNaN(e.id=parseInt(e.id,10))?n.reject(e):void t.del(e.id>>0,!0).then(function(e){n.resolve(e)},function(e){n.reject(e)})}).promise()}).then(function(e){u&&u.resolve(e)},function(e){u&&u.reject(e.msg||"收藏失败.")}),u.promise()},t.prototype.modifyGift=function(e,t){var i=[];n.each(t,function(e,t){var r=[];n.each(t,function(e,t){t.spuSeq&&r.push({sku_id:t.skuId,type:t.type,qty:t.qty,kind:t.kind})}),i.push(r)});var r={return_cart_data:!0,camp_seq:e,product_list:i};return this.send(a.COMMON_URL.GIFT_URL,n.extend(this.getDefaultCartData(),r))},t.prototype.modifyScore=function(e,t){var n=i.item(e),r={cart_detail_id:n.detailId,disc_type:t?1:0,is_html:!0};return this.send(a.COMMON_URL.SCORE_URL,r)},t}(s),D=new f;return D});
//# sourceMappingURL=cart.js.map