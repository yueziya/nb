(function(win,doc){var LOGIN_URL="http://id.ifeng.com/allsite/login";var LOGIN_SID_INTERVAL=null;var LOGIN_TK_INTERVAL=null;var LOGIN_IF_REAL=null;var LOGIN_SUCCESS_CALLBACK=[];var LOGIN_CLOSE_CALLBACK=[];var LOGIN_OUT_CALLBACK=[];var login_init=function(){if(login_cookie.get("sid")){if(LOGIN_SUCCESS_CALLBACK.length>0){for(var i=0,l=LOGIN_SUCCESS_CALLBACK.length;i<l;i++){LOGIN_SUCCESS_CALLBACK[i]({sid:login_cookie.get("sid"),uname:_processSidtoUname()})}}}else{_loginShow()}};var _login_listening=function(){clearInterval(LOGIN_TK_INTERVAL);clearInterval(LOGIN_SID_INTERVAL);clearInterval(LOGIN_IF_REAL);LOGIN_TK_INTERVAL=setInterval(_processTK,100);LOGIN_SID_INTERVAL=setInterval(_processSID,100);LOGIN_IF_REAL=setInterval(_ifRealName,100)};var _ifRealName=function(){if(login_cookie.get("sid")&&login_cookie.get("IF_REAL")==0){clearInterval(LOGIN_IF_REAL);doc.getElementById("login_index")&&doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker")&&doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"))}};var _processSID=function(){var options={};if(login_cookie.get("sid")){options.sid=login_cookie.get("sid");options.uname=_processSidtoUname();clearInterval(LOGIN_SID_INTERVAL);clearInterval(LOGIN_TK_INTERVAL);if(login_cookie.get("IF_REAL")==0){clearInterval(LOGIN_IF_REAL);doc.getElementById("login_index")&&doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker")&&doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"))}if(LOGIN_SUCCESS_CALLBACK.length>0){for(var i=0,l=LOGIN_SUCCESS_CALLBACK.length;i<l;i++){LOGIN_SUCCESS_CALLBACK[i](options)}}}};var _processTK=function(){var OTK="";if(""!==login_cookie.get("IF_OTK")){clearInterval(LOGIN_TK_INTERVAL);OTK=eval("("+decodeURIComponent(login_cookie.get("IF_OTK"))+")");if(1===OTK.code){login_cookie.del("IF_OTK",".ifeng.com");doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="320" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+OTK.data.url+'"></iframe>'}else{login_cookie.del("IF_OTK",".ifeng.com");doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+'"></iframe>';alert(OTK.message)}_login_listening()}};var _loginShow=function(){var _body=doc.body,loginIndex=doc.getElementById("login_index"),masker=null,_close=null;var currentDom=_getDom(_body.lastChild);if("undefined"!==typeof currentDom){if("undefined"===typeof loginIndex||null===loginIndex){masker=doc.createElement("div");masker.id="masker";masker.style.cssText="background:#000; position:fixed; left:0; top:0; bottom:0px; width:100%; height:100%; opacity:.80; filter:alpha(opacity=80); z-index:9999; overflow:hidden; zoom: 1; display: block;";currentDom.parentNode.insertBefore(login_html(),currentDom);doc.getElementById("login_index").parentNode.insertBefore(masker,doc.getElementById("login_index"));doc.getElementById("login_iframe_contain").style.cssText="position:fixed; _position:absolute; top:50%; left:50%; margin-left:-260px; margin-top: -207px; z-index:99999;"}else{if(doc.getElementById("login_iframe_out")){doc.getElementById("login_iframe_out").innerHTML='<iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+'"></iframe>'}masker=doc.getElementById("masker");masker.style["display"]="block";loginIndex.style["display"]="block"}_close=doc.getElementById("login_iframe_close_btn");_bindEvent.add(_close,"click",_loginHide);_login_listening()}};var _loginHide=function(){clearInterval(LOGIN_TK_INTERVAL);clearInterval(LOGIN_SID_INTERVAL);doc.getElementById("login_index")&&doc.getElementById("login_index").parentNode.removeChild(doc.getElementById("login_index"));doc.getElementById("masker")&&doc.getElementById("masker").parentNode.removeChild(doc.getElementById("masker"));if(LOGIN_CLOSE_CALLBACK.length>0){for(var i=0,l=LOGIN_CLOSE_CALLBACK.length;i<l;i++){LOGIN_CLOSE_CALLBACK[i]()}}};var login_out=function(){var _success=function(data){var i=0,str="",arr=[],iframesDIV=null,currentDom=null,poll_cookie=null;if(1===data.code){for(;i<data.data.turl.length;i++){str='<iframe style="display: none;" id="logout_'+i+'_iframe" src="'+data.data.turl[i]+'"></iframe>';arr.push(str)}iframesDIV=document.createElement("div");iframesDIV.id="iframesDIV";iframesDIV.innerHTML=arr.join("");currentDom=_getDom(document.body.lastChild);currentDom.parentNode.insertBefore(iframesDIV,currentDom);poll_cookie=setInterval(function(){if(""===login_cookie.get("sid")){clearInterval(poll_cookie);if(LOGIN_OUT_CALLBACK.length>0){for(var i=0,l=LOGIN_OUT_CALLBACK.length;i<l;i++){LOGIN_OUT_CALLBACK[i]()}}}},100)}};var options={url:"http://id.ifeng.com/index.php/api/logout",success:_success};ajax.jsonp(options)};var _getDom=function(node){if(node.nodeType===1){return node}if(node.previousSibling){return _getDom(node.previousSibling)}return null};var _bindEvent={add:function(obj,type,fn){if(obj.attachEvent){obj["e"+type+fn]=fn;obj[type+fn]=function(){obj["e"+type+fn](window.event)};obj.attachEvent("on"+type,obj[type+fn])}else{obj.addEventListener(type,fn,false)}},remove:function(obj,type,fn){if(obj.detachEvent){obj.detachEvent("on"+type,obj[type+fn]);obj[type+fn]=null}else{obj.removeEventListener(type,fn,false)}}};var login_html=function(){var _div=doc.createElement("div"),imgSrc="http://y0.ifengimg.com/a/2015/0827/close_small.png";_div.id="login_index";_div.style.cssText="width:1000px; margin:0 auto; display: block;";_div.innerHTML='<div id="login_iframe_contain"><i id="login_iframe_close_btn" style="cursor:pointer; position:absolute; right:-10px; top:-10px;"><a href="javascript:;" style="cursor:pointer;width:26px;height:26px;overflow:hidden;background:url('+imgSrc+") no-repeat;display:block;text-indent:-9999px;_background:none;_filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=scale, src='"+imgSrc+'\');">关闭</a></i><div id="login_iframe_out"><iframe id="login_iframe" width="520" height="410" scrolling="no" frameborder="no" border="0" style="border:0px; margin:0px;padding:0px;" src="'+LOGIN_URL+'"></iframe></div></div>';return _div};var login_cookie={get:function(name){var _=login_cookie,cookie=document.cookie,str=_._removeBlanks(cookie),pairs=str.split(";");for(var i=0;i<pairs.length;i++){var pairSplit=pairs[i].split("=");if(pairSplit.length>1&&pairSplit[0]===name){return pairSplit[1]}}return""},del:function(name,domain){document.cookie=name+"=; path=/; domain="+domain+"; expires=Thu, 01-Jan-70 00:00:01 GMT"},_removeBlanks:function(content){var temp="";for(var i=0;i<content.length;i++){var c=content.charAt(i);if(c!==" "){temp+=c}}return temp}};var ajax={jsonp:function(options){var url=options.url;var success=options.success;var data=[];var scope=options.scope||window;var callback;if(typeof options.data==="object"){for(var k in options.data){data.push(k+"="+encodeURIComponent(options.data[k]))}}if(typeof options.callback==="string"&&options.callback!==""){callback=options.callback}else{callback="f"+new Date().valueOf().toString(16)}data.push("callback="+callback);data.push("_="+(new Date().valueOf()));if(url.indexOf("?")<0){url=url+"?"+data.join("&")}else{url=url+"&"+data.join("&")}var insertScript=document.createElement("script");insertScript.src=url;window[callback]=function(){success.apply(scope,[].slice.apply(arguments).concat("success",options))};var oScript=document.getElementsByTagName("script")[0];oScript.parentNode.insertBefore(insertScript,oScript)}};var _processSidtoUname=function(){return login_cookie.get("sid")?decodeURIComponent(login_cookie.get("sid").substring(32)):decodeURIComponent(login_cookie.get("IF_USER"))};var isLogin=function(){return login_cookie.get("sid")?true:false};var regLoginCallback=function(type,callback){if("undefined"===typeof type||"undefined"===typeof callback){return false}switch(type){case 1:if("function"===typeof callback){LOGIN_SUCCESS_CALLBACK.push(callback);break}case 2:if("function"===typeof callback){LOGIN_CLOSE_CALLBACK.push(callback);break}case 3:if("function"===typeof callback){LOGIN_OUT_CALLBACK.push(callback);break}}};var reviewCheck=function(){if(login_cookie.get("sid")){if(login_cookie.get("IF_REAL")==0){return true}else{_loginShow();document.getElementById("login_iframe").src="http://id.ifeng.com/allsite/loginmob";return false}}else{_loginShow();return false}};win.IS_LOGIN=isLogin;win.GLOBAL_LOGIN=login_init;win.GLOBAL_LOGIN_OUT=login_out;win.REG_LOGIN_CALLBACK=regLoginCallback;win.ReviewCheck=reviewCheck})(window,document);
